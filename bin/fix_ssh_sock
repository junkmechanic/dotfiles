#!/usr/bin/env python2

import os
import sys
from plumbum import local
from plumbum.cmd import ln
from plumbum.commands import ProcessExecutionError

ssh_auth_sock = local.path('~/.ssh/ssh_auth_sock')

tmp_dir = local.path('/tmp')
ssh_sock_dirs = [dir for dir in tmp_dir.glob('ssh-*')
                 if dir.uid == os.geteuid()]
if len(ssh_sock_dirs) > 1:
    print 'Multiple auth sockets!!... Attempting to connect to one (anyone)..'

if not ssh_sock_dirs:
    print "Couldn't find the socket. Possibly agent is not running."
    sys.exit()

connected = False
for socket_dir in ssh_sock_dirs:
    socket = socket_dir.glob('agent.*')
    if not socket:
        continue
    try:
        ln('-sf', socket, ssh_auth_sock)
        connected = True
    except ProcessExecutionError as e:
        print e.stderr
        continue
if connected:
    print 'Done'
else:
    print "Couldn't connect to the socket."
